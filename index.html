// ========================================
// PARTIE 1 : CR√âATION ET NAVIGATION DU PLANNING
// ========================================
function creerPlanningEscapeGame() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  
  // Effacer tout le contenu existant
  sheet.clear();
  
  // LIGNE 1 : Jours de la semaine
  sheet.getRange('C1').setValue('SAMEDI');
  sheet.getRange('D1').setValue('DIMANCHE');
  sheet.getRange('E1').setValue('LUNDI');
  sheet.getRange('F1').setValue('MARDI');
  sheet.getRange('G1').setValue('MERCREDI');
  sheet.getRange('H1').setValue('JEUDI');
  sheet.getRange('I1').setValue('VENDREDI');
  
  // LIGNE 2 : Formules pour les dates (bas√©es sur SAMEDI en B19)
  sheet.getRange('C2').setFormula('=TEXT(B19;"DD/MM/YY")');
  sheet.getRange('D2').setFormula('=TEXT(B19+1;"DD/MM/YY")');
  sheet.getRange('E2').setFormula('=TEXT(B19+2;"DD/MM/YY")');
  sheet.getRange('F2').setFormula('=TEXT(B19+3;"DD/MM/YY")');
  sheet.getRange('G2').setFormula('=TEXT(B19+4;"DD/MM/YY")');
  sheet.getRange('H2').setFormula('=TEXT(B19+5;"DD/MM/YY")');
  sheet.getRange('I2').setFormula('=TEXT(B19+6;"DD/MM/YY")');
  
  // Cr√©neaux horaires et labels
  const creneaux = [
    { ligne: 3, heure: '10h' },
    { ligne: 6, heure: '12h' },
    { ligne: 9, heure: '14h' },
    { ligne: 12, heure: '17h' },
    { ligne: 15, heure: '19h' }
  ];
  
  creneaux.forEach(creneau => {
    // Colonne A : Heure
    sheet.getRange(creneau.ligne, 1).setValue(creneau.heure);
    
    // Colonne B : Labels
    sheet.getRange(creneau.ligne, 2).setValue('nom:');
    sheet.getRange(creneau.ligne + 1, 2).setValue('nbr de pers:');
    sheet.getRange(creneau.ligne + 2, 2).setValue('tel:');
  });
  
  // LIGNE 19 : Date du SAMEDI de la semaine
  sheet.getRange('A19').setValue('SAMEDI DE LA SEMAINE');
  sheet.getRange('B19').setValue('11/01/2026');
  
  // Mise en forme
  sheet.getRange('C1:I1').setFontWeight('bold').setHorizontalAlignment('center').setBackground('#d9d9d9');
  sheet.getRange('C2:I2').setFontWeight('bold').setHorizontalAlignment('center');
  sheet.getRange('A3:A17').setFontWeight('bold').setVerticalAlignment('middle').setHorizontalAlignment('center');
  sheet.getRange('B3:B17').setHorizontalAlignment('left');
  
  // Largeur des colonnes
  sheet.setColumnWidth(1, 60);
  sheet.setColumnWidth(2, 100);
  for (let i = 3; i <= 9; i++) {
    sheet.setColumnWidth(i, 120);
  }
  
  // Hauteur des lignes
  sheet.setRowHeight(1, 30);
  sheet.setRowHeight(2, 30);
  
  // Bordures
  sheet.getRange('A1:I17').setBorder(true, true, true, true, true, true);
  
  // Masquer la ligne 19
  sheet.hideRows(19);
  
  // Formater B19 comme date
  sheet.getRange('B19').setNumberFormat('dd/mm/yyyy');
  
  SpreadsheetApp.getUi().alert('‚úÖ Planning cr√©√© avec succ√®s !\n\nPour changer de semaine, cliquez sur le menu "üéÆ Escape Game"');
}

// Menu personnalis√©
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('üéÆ Escape Game')
    .addItem('Cr√©er le planning', 'creerPlanningEscapeGame')
    .addItem('Semaine suivante', 'semaineSuivante')
    .addItem('Semaine pr√©c√©dente', 'semainePrecedente')
    .addToUi();
}

// Notification automatique lors de modifications manuelles du planning
function onEdit(e) {
  try {
    const sheet = e.source.getActiveSheet();
    const range = e.range;
    const row = range.getRow();
    const col = range.getColumn();
    
    // V√©rifier si c'est une modification dans la zone du planning (lignes 3-17, colonnes C-I)
    if (row >= 3 && row <= 17 && col >= 3 && col <= 9) {
      const user = Session.getActiveUser().getEmail() || "Un utilisateur";
      const cellAddress = range.getA1Notation();
      const oldValue = e.oldValue || "(vide)";
      const newValue = e.value || "(vide)";
      
      // R√©cup√©rer le jour et l'heure concern√©s
      const dayName = sheet.getRange(1, col).getValue();
      const dayDate = sheet.getRange(2, col).getValue();
      
      // D√©terminer le cr√©neau horaire
      let timeSlot = "";
      if (row >= 3 && row <= 5) timeSlot = "10h";
      else if (row >= 6 && row <= 8) timeSlot = "12h";
      else if (row >= 9 && row <= 11) timeSlot = "14h";
      else if (row >= 12 && row <= 14) timeSlot = "17h";
      else if (row >= 15 && row <= 17) timeSlot = "19h";
      
      const sujet = "‚ö†Ô∏è Modification manuelle du planning Escape Game";
      const corps = `
Une modification a √©t√© effectu√©e sur le planning :

üë§ Modifi√© par : ${user}
üìÖ Jour : ${dayName} ${dayDate}
üïê Cr√©neau : ${timeSlot}
üìç Cellule : ${cellAddress}

Ancienne valeur : ${oldValue}
Nouvelle valeur : ${newValue}

---
Notification automatique - Escape Game Valfr√©jus
      `;
      
      MailApp.sendEmail("juliencoudou@hotmail.com", sujet, corps);
    }
  } catch (error) {
    Logger.log("Erreur notification modification: " + error.toString());
  }
}

// Navigation semaines
function semaineSuivante() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  const dateActuelle = new Date(sheet.getRange('B19').getValue());
  dateActuelle.setDate(dateActuelle.getDate() + 7);
  sheet.getRange('B19').setValue(dateActuelle);
  SpreadsheetApp.getUi().alert('‚û°Ô∏è Semaine suivante !');
}

function semainePrecedente() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  const dateActuelle = new Date(sheet.getRange('B19').getValue());
  dateActuelle.setDate(dateActuelle.getDate() - 7);
  sheet.getRange('B19').setValue(dateActuelle);
  SpreadsheetApp.getUi().alert('‚¨ÖÔ∏è Semaine pr√©c√©dente !');
}

// ========================================
// PARTIE 2 : GESTION DES R√âSERVATIONS EN LIGNE
// ========================================

// Lire les r√©servations existantes (GET)
function doGet(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    const reservations = [];
    
    // Lire les dates de la semaine (ligne 2, colonnes C √† I)
    const datesRange = sheet.getRange('C2:I2');
    const datesValues = datesRange.getValues()[0];
    
    // Cr√©neaux horaires et leurs lignes correspondantes
    const creneaux = [
      { heure: '10h', ligneNom: 3 },
      { heure: '12h', ligneNom: 6 },
      { heure: '14h', ligneNom: 9 },
      { heure: '17h', ligneNom: 12 },
      { heure: '19h', ligneNom: 15 }
    ];
    
    // Pour chaque jour (colonnes C=3 √† I=9)
    for (let colIndex = 0; colIndex < 7; colIndex++) {
      let dateCell = datesValues[colIndex];
      
      // Convertir la date en format DD/MM/YY
      let dateStr;
      if (dateCell instanceof Date) {
        dateStr = Utilities.formatDate(dateCell, Session.getScriptTimeZone(), "dd/MM/yy");
      } else {
        dateStr = dateCell.toString().trim();
      }
      
      const colLetter = String.fromCharCode(67 + colIndex); // C=67, D=68...
      
      // Pour chaque cr√©neau horaire
      creneaux.forEach(creneau => {
        // Lire la cellule "nom:" pour voir si le cr√©neau est occup√©
        const nomCell = sheet.getRange(colLetter + creneau.ligneNom).getValue();
        
        // Si la cellule nom contient quelque chose, le cr√©neau est r√©serv√©
        if (nomCell && nomCell.toString().trim() !== '') {
          reservations.push({
            date: dateStr,
            heure: creneau.heure
          });
        }
      });
    }
    
    return ContentService.createTextOutput(JSON.stringify({
      status: 'success',
      reservations: reservations
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      status: 'error',
      message: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// Enregistrer une nouvelle r√©servation (POST)
function doPost(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    const data = JSON.parse(e.postData.contents);
    
    // Date envoy√©e par la page : "2026-01-13" (format ISO)
    const sentDate = data.date;
    const [y, m, d] = sentDate.split('-');
    const dayNum = parseInt(d, 10);
    const monthNum = parseInt(m, 10);
    const yearShort = y.slice(2);
    
    // Lire la date de r√©f√©rence (SAMEDI en B19)
    const samediDate = new Date(sheet.getRange('B19').getValue());
    
    // Calculer l'index de colonne en fonction du jour de la semaine
    const targetDate = new Date(parseInt(y), parseInt(m) - 1, parseInt(d));
    
    // SAMEDI = colonne C (3), DIMANCHE = D (4), LUNDI = E (5), etc.
    const joursSemaine = ['DIMANCHE', 'LUNDI', 'MARDI', 'MERCREDI', 'JEUDI', 'VENDREDI', 'SAMEDI'];
    const dayOfWeek = targetDate.getDay(); // 0=dimanche, 1=lundi, ..., 6=samedi
    
    // Mapping jour de la semaine -> colonne
    let colIndex;
    if (dayOfWeek === 6) { // Samedi
      colIndex = 3; // C
    } else if (dayOfWeek === 0) { // Dimanche
      colIndex = 4; // D
    } else { // Lundi (1) √† Vendredi (5)
      colIndex = 4 + dayOfWeek; // E (5) √† I (9)
    }
    
    // V√©rifier que la date correspond bien √† la semaine affich√©e
    const cellDate = sheet.getRange(2, colIndex).getValue();
    let cellDateStr;
    if (cellDate instanceof Date) {
      cellDateStr = Utilities.formatDate(cellDate, Session.getScriptTimeZone(), "dd/MM/yy");
    } else {
      cellDateStr = cellDate.toString().trim();
    }
    
    const expectedDateStr1 = `${dayNum}/${monthNum}/${yearShort}`;
    const expectedDateStr2 = `${dayNum.toString().padStart(2,'0')}/${monthNum.toString().padStart(2,'0')}/${yearShort}`;
    
    if (cellDateStr !== expectedDateStr1 && cellDateStr !== expectedDateStr2) {
      return ContentService.createTextOutput(JSON.stringify({
        status: 'error',
        message: `Date non trouv√©e. Attendu: ${expectedDateStr1} ou ${expectedDateStr2}, Trouv√©: ${cellDateStr}`
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    // Trouver la ligne du cr√©neau
    const heure = data.heure.trim();
    const creneauxMap = {
      '10h': 3,
      '12h': 6,
      '14h': 9,
      '17h': 12,
      '19h': 15
    };
    
    const rowOffset = creneauxMap[heure];
    
    if (!rowOffset) {
      return ContentService.createTextOutput(JSON.stringify({
        status: 'error',
        message: 'Cr√©neau horaire non valide: ' + heure
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    // V√©rifier si le cr√©neau est d√©j√† occup√©
    const existingNom = sheet.getRange(rowOffset, colIndex).getValue();
    if (existingNom && existingNom.toString().trim() !== '') {
      return ContentService.createTextOutput(JSON.stringify({
        status: 'error',
        message: 'Ce cr√©neau est d√©j√† r√©serv√©'
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    // √âcrire les informations dans les 3 lignes
    sheet.getRange(rowOffset, colIndex).setValue(data.nom.trim());
    sheet.getRange(rowOffset + 1, colIndex).setValue(data.pers_niveau.trim());
    sheet.getRange(rowOffset + 2, colIndex).setValue(data.telephone.trim());
    
    // Envoyer les emails de confirmation
    envoyerEmailConfirmation(data);
    
    return ContentService.createTextOutput(JSON.stringify({
      status: 'success',
      message: 'R√©servation enregistr√©e avec succ√®s',
      data: {
        nom: data.nom,
        date: data.date,
        heure: data.heure,
        participants: data.pers_niveau
      }
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      status: 'error',
      message: error.message || error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// Fonction pour envoyer les emails de confirmation
function envoyerEmailConfirmation(data) {
  try {
    // Formater la date en fran√ßais
    const [y, m, d] = data.date.split('-');
    const dateObj = new Date(parseInt(y), parseInt(m) - 1, parseInt(d));
    const dateFormatee = dateObj.toLocaleDateString('fr-FR', { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    });
    
    // ============================================
    // EMAIL 1 : CONFIRMATION AU CLIENT
    // ============================================
    const sujetClient = "‚úÖ Confirmation de r√©servation - Escape Game Valfr√©jus";
    
    const corpsClient = `
Bonjour ${data.nom},

Votre r√©servation a bien √©t√© enregistr√©e !

üìã R√âCAPITULATIF DE VOTRE R√âSERVATION :

üë§ Nom : ${data.nom}
üìÖ Date : ${dateFormatee}
üïê Heure : ${data.heure}
üë• Participants : ${data.pers_niveau}
üí∞ Prix : ${data.prix_par_personne}‚Ç¨/personne - Total : ${data.prix_total}‚Ç¨
üìû T√©l√©phone : ${data.telephone}
üìß Email : ${data.email}

Nous vous attendons avec impatience pour cette aventure √† Valfr√©jus !

En cas de besoin, n'h√©sitez pas √† nous contacter au 0479053376.

Cordialement,
L'√©quipe Escape Game Valfr√©jus
    `;
    
    MailApp.sendEmail(data.email, sujetClient, corpsClient);
    
    // ============================================
    // EMAIL 2 : NOTIFICATION POUR JULIEN
    // ============================================
    const sujetJulien = "üéÆ Nouvelle r√©servation Escape Game - " + dateFormatee + " √† " + data.heure;
    
    const corpsJulien = `
NOUVELLE R√âSERVATION ENREGISTR√âE !

üìã D√âTAILS DE LA R√âSERVATION :

üë§ Nom : ${data.nom}
üìÖ Date : ${dateFormatee}
üïê Heure : ${data.heure}
üë• Participants : ${data.pers_niveau}
üí∞ Prix : ${data.prix_par_personne}‚Ç¨/personne - Total : ${data.prix_total}‚Ç¨
üìû T√©l√©phone : ${data.telephone}
üìß Email : ${data.email}

Cette r√©servation a √©t√© automatiquement ajout√©e au planning Google Sheets.

---
Notification automatique - Escape Game Valfr√©jus
    `;
    
    MailApp.sendEmail("juliencoudou@hotmail.com", sujetJulien, corpsJulien);
    
  } catch (error) {
    Logger.log("Erreur envoi email: " + error.toString());
  }
}
