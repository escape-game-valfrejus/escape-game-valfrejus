// Ajoute cette nouvelle fonction après la fonction formatDateForSheet()

function isSlotAvailableByTime(slot, selectedDate) {
  const now = new Date();
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  const compareDate = new Date(selectedDate);
  compareDate.setHours(0, 0, 0, 0);
  
  // Si ce n'est pas aujourd'hui, le créneau est disponible (pas de restriction temporelle)
  if (compareDate.getTime() !== today.getTime()) {
    return true;
  }
  
  // C'est aujourd'hui, on vérifie l'heure avec le délai de 30 min
  const slotTimes = {
    '10h': 10,
    '12h': 12,
    '14h': 14,
    '17h': 17,
    '19h': 19
  };
  
  const slotHour = slotTimes[slot];
  if (!slotHour) return true;
  
  // Créer l'heure du créneau aujourd'hui
  const slotTime = new Date();
  slotTime.setHours(slotHour, 0, 0, 0);
  
  // Soustraire 30 minutes pour obtenir l'heure limite de réservation
  const blockTime = new Date(slotTime.getTime() - 30 * 60 * 1000);
  
  // Si l'heure actuelle est >= à l'heure de blocage, le créneau n'est plus disponible
  return now < blockTime;
}


// REMPLACE la fonction renderSlots() par celle-ci :

function renderSlots() {
  const container = document.getElementById('slot-list');
  container.innerHTML = '';

  const dayOfWeek = selectedDate.getDay();
  const dateKey = formatDateForSheet(selectedDate);

  allSlots.forEach(slot => {
    if ((dayOfWeek === 0 || dayOfWeek === 6) && (slot === '10h' || slot === '12h')) {
      return;
    }

    const slotEl = document.createElement('div');
    slotEl.className = 'slot';
    slotEl.textContent = slot;

    const isReserved = reservedSlots.has(`${dateKey}_${slot}`);
    const isAvailableByTime = isSlotAvailableByTime(slot, selectedDate);
    
    if (isReserved || !isAvailableByTime) {
      slotEl.classList.add('disabled');
    } else {
      slotEl.onclick = () => selectSlot(slot, slotEl);
    }

    container.appendChild(slotEl);
  });
}


// REMPLACE la fonction confirmerReservation() par celle-ci :

async function confirmerReservation() {
  const nom = document.getElementById('nom').value.trim();
  const email = document.getElementById('email').value.trim();
  const participants = document.getElementById('participants').value;
  const niveau = document.getElementById('niveau').value;
  const telephone = document.getElementById('telephone').value.trim();

  if (!nom || !email || !participants || !niveau || !telephone) {
    showError("Veuillez remplir tous les champs");
    return;
  }

  if (!email.includes('@') || !email.includes('.')) {
    showError("Email invalide");
    return;
  }

  const btn = document.getElementById('confirm-btn');
  btn.disabled = true;
  btn.textContent = 'Vérification...';

  // VÉRIFICATION 1 : Le créneau est-il encore disponible par rapport à l'heure ?
  if (!isSlotAvailableByTime(selectedSlot, selectedDate)) {
    showError("⚠️ Désolé, ce créneau n'est plus disponible (délai de 30 minutes dépassé). Veuillez choisir un autre créneau.");
    btn.disabled = false;
    btn.textContent = '✓ Confirmer la réservation';
    
    // Rafraîchir l'affichage des créneaux
    renderSlots();
    return;
  }

  // VÉRIFICATION 2 : Le créneau est-il toujours disponible (pas réservé par quelqu'un d'autre) ?
  try {
    await loadReservations();
    
    const dateKey = formatDateForSheet(selectedDate);
    const isNowReserved = reservedSlots.has(`${dateKey}_${selectedSlot}`);
    
    if (isNowReserved) {
      showError("⚠️ Désolé, ce créneau vient d'être réservé par quelqu'un d'autre. Veuillez choisir un autre créneau.");
      btn.disabled = false;
      btn.textContent = '✓ Confirmer la réservation';
      
      // Rafraîchir l'affichage des créneaux
      renderSlots();
      return;
    }
  } catch (err) {
    showError("Erreur de vérification. Veuillez réessayer.");
    btn.disabled = false;
    btn.textContent = '✓ Confirmer la réservation';
    return;
  }

  // Le créneau est libre, on continue avec la réservation
  const niveauSymboles = { '-': '-', '+': '+', '++': '++', '+++': '+++' };
  const persAvecNiveau = `${participants} ${niveauSymboles[niveau]}`;
  
  const price = priceTable[participants];

  const payload = {
    date: formatDate(selectedDate),
    heure: selectedSlot,
    nom: nom,
    email: email,
    pers_niveau: persAvecNiveau,
    telephone: telephone,
    prix_par_personne: price.perPerson,
    prix_total: price.total
  };

  btn.textContent = 'Envoi en cours...';

  try {
    await fetch(scriptUrl, {
      method: 'POST',
      mode: 'no-cors',
      body: JSON.stringify(payload),
      headers: { 'Content-Type': 'text/plain' }
    });

    await new Promise(resolve => setTimeout(resolve, 2000));
    await loadReservations();
    
    const dateKey = formatDateForSheet(selectedDate);
    const isNowReserved = reservedSlots.has(`${dateKey}_${selectedSlot}`);
    
    if (isNowReserved) {
      afficherRecap(payload);
      document.getElementById('booking-form').style.display = 'none';
      
      document.getElementById('nom').value = '';
      document.getElementById('email').value = '';
      document.getElementById('participants').value = '';
      document.getElementById('niveau').value = '';
      document.getElementById('telephone').value = '';
      document.getElementById('price-display').style.display = 'none';
    } else {
      showError("Impossible de vérifier la réservation");
    }
  } catch (err) {
    showError("Erreur de connexion");
    console.error(err);
  } finally {
    btn.disabled = false;
    btn.textContent = '✓ Confirmer la réservation';
  }
}
